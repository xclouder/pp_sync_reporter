<!DOCTYPE html>
<html>
<head>
<title>SyncReport Viewer</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="stylesheet" href="style.css" type="text/css">
<script src="amcharts/amcharts/amcharts.js" type="text/javascript"></script>
<script src="amcharts/amcharts/serial.js" type="text/javascript"></script>

<style>
    body {
        width: 900px;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }

    #timeline {
    	height:500px;
    }

    table.hovertable {
		font-family: verdana,arial,sans-serif;
		font-size:11px;
		color:#333333;
		border-width: 1px;
		border-color: #999999;
		border-collapse: collapse;
	}
	table.hovertable th {
		background-color:#c3dde0;
		border-width: 1px;
		padding: 8px;
		border-style: solid;
		border-color: #a9c6c9;
	}
	table.hovertable tr {
		background-color:#d4e3e5;
	}
	table.hovertable td {
		border-width: 1px;
		padding: 8px;
		border-style: solid;
		border-color: #a9c6c9;
	}

/*	.chartWrapper {
		position: relative;
	}

	.chartWrapper > canvas {
		position: absolute;
		left: 0;
		top: 0;
		pointer-events: none;
	}

	.chartAreaWrapper {
		width: 15000px;
		overflow-x: scroll;
	}*/

</style>
<script type="text/javascript" src="jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="timeline-parser.js"></script>
<body>

<h3>比赛信息</h3>
<div>
	<h4>OpenId:</h4>
	<p id="openId">pending...</p>
	
	<h4>车位置:</h4>
	<p id="carIndex">pending...</p>

	<h4>房间Id:</h4>
	<p id="roomId">pending...</p>

	<h4>游戏开始时间:</h4>
	<p id="gameTime">pending...</p>
</div>

<br/>
<h3>关键数据图表</h3>
<div class="chartWrapper" >

</div>


<h3>当前帧Timeline</h3>
<div id = "timeline">
	<table class="hovertable">
		<tr>
			<td>时间</td>
			<td>类型</td>
			<td>描述</td>
		</tr>
	</table>
</div>

<script>

$(document).ready(function(){

	function fillRaceInfo(raceInfo)
	{
		$('#openId').html(raceInfo.myOpenId);
		$('#carIndex').html(raceInfo.myCarIndex);
		$('#roomId').html(raceInfo.roomId);
		$('#gameTime').html(raceInfo.startDateTime);
	}

	/*mapCfg format:
	[
	{from:"key1", to:"mapped_key1"},
	{from:"key2", to:"mapped_key2"},
	]
	*/
	function mapObjectArray(arr, mapCfg)
	{
		var newArr = new Array();

		if (!arr)
		{
			return newArr;
		}

		for(var j = 0; j < arr.length; j++){
			var data = arr[j];
			var mappedObj = {};

			for (var k = 0; k < mapCfg.length; k++)
			{
				cfg = mapCfg[k];

				mappedObj[cfg.to] = data[cfg.from];
			}
			
			newArr.push(mappedObj);
		}

		return newArr;
	}

	/*
	car info struct:
	{
		index: 0,
		deltaPosArray:[{
			time:111,
			value:222
		}],
		receivePacks:{
			time:111,
			...
		}
	}

	*/
	function getCarInfos(rawCars)
	{
		var infos = new Array();

		if (!rawCars)
		{
			return infos;
		}

		for (var i = 0; i < rawCars.length; i++)
		{
			rawData = rawCars[i];

			var info = {
				index : i,
				deltaPosArray : [],
				receivePcksArray:[],	//value为收包时间-发包时间
				timelineArray : [],
			};

			var recArr = rawData.recItemList;
			if (recArr != null)
			{

				//parse deltaPos
				for (var k = 0; k < recArr.length; k++)
				{
					var rec = recArr[k];
					if (rec.recType == 0)	// enum 0 > DeltaPos
					{
						info.deltaPosArray.push(rec);
					}
				}

				timelineArr = rawData.timelineDataList;
				for (var k = 0; k < timelineArr.length; k++)
				{
					var tln = timelineArr[k];
					var tlnEvtArr = tln.evtList;

					//receive pack
					var rawReceivePack = tlnEvtArr[0];
					if (rawReceivePack.evt == 0)
					{
						var _recvData = {
							time: rawReceivePack.time,
							value: (rawReceivePack.data.rcvTime - rawReceivePack.data.sendTime)
						};

						info.receivePcksArray.push(_recvData);
					}
					else
					{
						console.error("error! first timeline evt is not receive pack");
					}

					info.timelineArray.push(tlnEvtArr);
				}

				infos[i] = info; 
			}
		}
		return infos;
	}

	CAR_COLORS = [
		"rgb(66, 33, 66)",
		"rgb(66, 132, 96)",
		"rgb(143, 132, 96)",
		"rgb(3, 132, 96)",
		"rgb(201, 63, 96)",
		"rgb(186, 132, 0)",
	];

	CAR_COLORS_RECV_PACK = [
		"rgb(166, 93, 16)",
		"rgb(6, 232, 196)",
		"rgb(155, 12, 33)",
		"rgb(31, 232, 196)",
		"rgb(201, 63, 6)",
		"rgb(99, 132, 132)",
	];

	function getCarColor(index)
	{
		return CAR_COLORS[index];
	}

	function getCarColorRecvPack(index)
	{
		return CAR_COLORS_RECV_PACK[index];
	}

	function getRecordData(arr)
	{
		return mapObjectArray(arr, [{from:"time", to:"x"},
			{from:"value", to:"y"}]);
	}

	var fileUrl = "http://localhost/synclogs/2.rec"
	var myChart = null;
	var dataSets = [];
	var carInfos = {};

	// var fileUrl = "https://ppgame-1256574976.cos.ap-shanghai.myqcloud.com/sync/20180426/10/26/50331649/98B1113A78ED29C176793EC70453DE80_50331649_20180426-10-26-25.rec";
 	$.get(fileUrl, function(result){
 		var logData = JSON.parse(result);
 		//console.log(logData);

 		fillRaceInfo(logData.raceInfo);

 		//RTT
 		var rtt = logData.rtt;
 		var rttData = getRecordData(rtt);

/*
 		//RTT数据
 		dataSets.push(
 			{
	            label: "RTT",
	            data: rttData,
	            fill: false,
	            borderColor: "rgb(75, 192, 66)",
	            lineTension: 0,	//performance better
	            showLine: true,
	            spanGaps: false
	        }
 		);

 		//RTT基准线数据
 		dataSets.push({
            label: "desired RTT",
            data: [{x:28000,y:60}, {x:220000, y:60}],
            fill: false,
            borderColor: "rgb(175, 192, 66)",
            lineStyle:"dash",
            lineTension: 0,	//performance better
            showLine: true,
            borderDash: [10,5],
            spanGaps: false
        });

        //FPS
        var fps = logData.fps;
        var fpsData = getRecordData(fps);
        dataSets.push(
 			{
	            label: "FPS",
	            data: fpsData,
	            fill: false,
	            borderColor: "rgb(200, 16, 66)",
	            lineTension: 0,	//performance better
	            showLine: true,
	            spanGaps: false
	        }
 		);

 		//analyze car data(DeltaPos Distance, and so on)
 		carInfos = getCarInfos(logData.cars);
 		for (var prop in carInfos)
 		{
 			var carInfo = carInfos[prop];
 			var deltaPosData = getRecordData(carInfo.deltaPosArray);

 			var _dataSet = {
 				canRelateToTimeline: true,
 				carIndex: carInfo.index,
	            label: "DeltaPos(Car-" + carInfo.index + ")",
	            data: deltaPosData,
	            fill: false,
	            borderColor: getCarColor(carInfo.index),
	            lineTension: 0,	//performance better
	            showLine: true,
	            spanGaps: false
	        };

	        dataSets.push(_dataSet);

	        var recvPackData = getRecordData(carInfo.receivePcksArray);
	        var _dataSet_RecvPack = {
	        	label: "RecvPack(Car-" + carInfo.index + ")",
	            data: recvPackData,
	            fill: false,
	            borderColor: getCarColorRecvPack(carInfo.index),
	            lineTension: 0,	//performance better
	            showLine: true,
	            spanGaps: false
	        }

	        dataSets.push(_dataSet_RecvPack);
 		}
*/
 		
		var chart;
		var chartData = [];

		/*
		// GUIDE for average
        var guide = new AmCharts.Guide();
        guide.value = average;
        guide.lineColor = "#CC0000";
        guide.dashLength = 4;
        guide.label = "average";
        guide.inside = true;
        guide.lineAlpha = 1;
        valueAxis.addGuide(guide);
		*/
		
 	});

 	
    function renderTimelineInfo(timeline)
    {
    	var htmlArr = [];

		/*
		<table class="hovertable">
			<tr>
				<td>时间</td>
				<td>类型</td>
				<td>描述</td>
			</tr>
		</table>
		*/
    	htmlArr.push("<table class='hovertable'>");
    	htmlArr.push("<tr><td>时间</td><td>类型</td><td>描述</td></tr>");

    	for (var i = 0; i < timeline.length; i++)
    	{
    		var item = timeline[i];
    		var descriptor = timelineDesFactory.getDescriptor(item.evt);
			var data = descriptor.getDesItem(item);

			htmlArr.push("<tr>");

	    	htmlArr.push("<td>");
	    	htmlArr.push(data.time);
	    	htmlArr.push("</td>");

	    	htmlArr.push("<td>");
	    	htmlArr.push(data.evt);
	    	htmlArr.push("</td>");

	    	htmlArr.push("<td>");
	    	htmlArr.push(data.des);
	    	htmlArr.push("</td>");

	    	htmlArr.push("</tr>");
    	}

	    	
		htmlArr.push("</table>");

    	var html = htmlArr.join("");
    	$("#timeline").html(html);
    }

    function clearTimelineInfo()
    {
    	$("#timeline").html("invalid");
    }

});


</script>
</body>
</html>
